---
title: "Compare Raw and Interpolated Global Panel"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Compare Raw and Interpolated Global Panel}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# _notes/issues/issues_20240526_interpolation_stats.md
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tibble)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(ggplot2)
library(kableExtra)

library(PrjCompPPTS)
```

In this vignette, we show, for each country and in the output table below, the total number of yearly data points in our [global primary panel dataset](https://fanwangecon.github.io/PrjCompPPTS/reference/ppts_easia_weuro_world.html), observed between 1920 and 2020. We also show the share of these data points that is based on administrative data. The remaining data points are based on [interpolating and extrapolating](https://fanwangecon.github.io/PrjCompPPTS/articles/ffv_gen_percent_changes.html) the administrative data.

See the output table show these stats in [res-tab/country_interpolate.tex](https://github.com/FanWangEcon/PrjCompPPTS/tree/master/res-tab/country_interpolate.tex).

Then we visualize the years in which we interpolate and extrapolate as well as years in which we have admin data for the selected economies in Eastern Asia and Western Europe that we consider in the paper.

```{r}
spt_path_res <- file.path("..", "res-tab", fsep = .Platform$file.sep)
spn_tex_out <- file.path(spt_path_res, "country_interpolate.tex", fsep = .Platform$file.sep)
bl_tex_save <- FALSE
verbose <- TRUE
```

## Load and select

Load in country code.

```{r}
ppts_country_code <- PrjCompPPTS::ppts_country_code
ppts_country_code_sel <- ppts_country_code %>% 
  filter(!is.na(location_region_group)) %>%
  arrange(
      location_region_group_code, 
      location_name
    )
print(
  ppts_country_code_sel, 
  n = 300
)
```

Load in the dataset generated by [articles/ffv_gen_percent_changes](https://fanwangecon.github.io/PrjCompPPTS/articles/ffv_gen_percent_changes.html).

```{r}
ppts_easia_weuro_world_pchg <- PrjCompPPTS::ppts_easia_weuro_world_pchg
ppts_easia_weuro_world_pchg %>% distinct(year_bins_type)
ppts_easia_weuro_world_pchg %>% distinct(variable)
ppts_pchg <- ppts_easia_weuro_world_pchg %>% 
  filter(
    year_bins_type == "1940t2020i01", 
    variable %in% c("youthpop", "student", "teacher", "school")
    ) %>% 
  select(
    location_code, 
    location_level,location_code, variable, 
    year_bins, 
    pchg, pchg_interp1, value, value_interp1
  )
```

Annual year variable as numeric and sort. 

```{r}
ppts_pchg <- ppts_pchg %>% 
  rename(year = year_bins) %>% 
  mutate(year = as.numeric(year)) %>%
  arrange(
    location_code, variable, year
  )
```

## Compare interpolated and raw data by countries and decades 

First, from `data/ppts_easia_weuro_world_pchg.rda`, generate year groups. We generate three year groupings, one is based on all years, one is based on each decade. 

```{r}
# Get all years
ar_year <- ppts_pchg %>% 
  distinct(year) %>% pull(year)

# Min and max years
fl_it_year_min <- min(ar_year)
fl_it_year_max <- max(ar_year)

# collect
ls_ar_years_cates <- vector(mode = "list", length = 3)
ls_st_years_cates_labels <- vector(mode = "list", length = 3)

# Year groups for summarizing, all years jointly
ar_it_year_cates <- c(1920, 2021)
ar_st_year_cates_labels <- c("1920 to 2020")
ls_ar_years_cates[[1]] <- ar_it_year_cates
ls_st_years_cates_labels[[1]] <- ar_st_year_cates_labels

# Year groups for summarizing, per two decade groupings
it_year_groups <- 6
ar_it_year_cates <- seq(1920, 2020, length.out=it_year_groups)
ar_it_year_cates[6] <- 2021
ar_st_year_cates_labels <- paste0(ar_it_year_cates[1:(it_year_groups-2)], " to ", ar_it_year_cates[2:(it_year_groups-1)] - 1)
ar_st_year_cates_labels <- c(ar_st_year_cates_labels, "2000 to 2020")
ls_ar_years_cates[[2]] <- ar_it_year_cates
ls_st_years_cates_labels[[2]] <- ar_st_year_cates_labels

# Year groups for summarizing, per decade groupings
it_year_groups <- 11
ar_it_year_cates <- seq(1920, 2020, length.out=it_year_groups)
ar_it_year_cates[11] <- 2021
ar_st_year_cates_labels <- paste0(ar_it_year_cates[1:(it_year_groups-2)], " to ", ar_it_year_cates[2:(it_year_groups-1)] - 1)
ar_st_year_cates_labels <- c(ar_st_year_cates_labels, "2010 to 2020")
ls_ar_years_cates[[3]] <- ar_it_year_cates
ls_st_years_cates_labels[[3]] <- ar_st_year_cates_labels
```

Second, generate year groupings.

```{r}
# year groups for summarizing
ppts_pchg_longer <- ppts_pchg %>% 
  mutate(
    year_group_1 = base::cut(year,
        breaks = ls_ar_years_cates[[1]], 
        labels = ls_st_years_cates_labels[[1]],
        right = FALSE
      ),
    year_group_2 = base::cut(year,
        breaks = ls_ar_years_cates[[2]], 
        labels = ls_st_years_cates_labels[[2]],
        right = FALSE
      ),
    year_group_3 = base::cut(year,
        breaks = ls_ar_years_cates[[3]], 
        labels = ls_st_years_cates_labels[[3]],
        right = FALSE
      )
  ) %>% 
  pivot_longer(cols = starts_with('year_group'),
              names_to = c('year_group_set'),
              names_pattern = paste0("year_group_(.*)"),
              values_to = "year_group")
```

Third, group by country, variable, decade and count data observations, do this for both interp or not.

```{r}
# year groups for summarizing
ppts_pchg_grp <- ppts_pchg_longer %>% 
  group_by(
    location_code, variable, year_group_set, year_group,
    ) %>% 
  summarize(
    pchg_itp_cnt = sum(!is.na(value_interp1)),
    pchg_raw_cnt = sum(!is.na(value)),
    pchg_raw_shr = pchg_raw_cnt/pchg_itp_cnt,
  )
# ppts_pchg_grp %>% filter(location_code == "TWN", variable == "school", year_group_set == 1)
# print(ppts_pchg_longer %>% filter(location_code == "TWN", variable == "school", year_group_set == 1), n = 100)
```

Fourth, reshape variables from long to wide for four key variables.

```{r}
# year groups for summarizing
ppts_pchg_grp_wider <- ppts_pchg_grp %>% 
  pivot_wider(id_cols = c(
      "location_code", 
      "year_group_set", 
      "year_group"
    ),
    names_from = "variable",
    names_prefix = "",
    values_from = c(
      pchg_itp_cnt, pchg_raw_shr
    ))  
```


Fifth, use table-maker to generate a table, highlighting share of data from each country interpolated/extrapolated.

```{r}
ppts_pchg_grp_tab <- ppts_pchg_grp_wider %>% 
  left_join(ppts_country_code_sel, by = "location_code") %>%
  arrange(
   location_region_group_code, location_name,  
  ) %>%
  filter(
    !is.na(location_name)
  ) %>%
  filter(
    year_group_set == 1
    ) %>% 
  select(
    location_region_group,
    location_region_group_code,
    location_code,
    location_name,
    year_group_set,
    year_group,
    pchg_itp_cnt_youthpop,
    pchg_raw_shr_youthpop,
    pchg_itp_cnt_student,
    pchg_raw_shr_student,
    pchg_itp_cnt_teacher,
    pchg_raw_shr_teacher,
    pchg_itp_cnt_school,
    pchg_raw_shr_school
  )
```

## Generate table and statistics

Sort and generate group counts. 

```{r}
# Sorted file
df_data_sorted <- ppts_pchg_grp_tab %>%
  rename(
    group_sorter_desc = location_region_group,
    group_sorter = location_region_group_code, 
    country_name = location_name
  ) %>%
  arrange(
    group_sorter, location_code,
  ) %>%
  group_by(group_sorter) %>%
  ungroup()
# Count by group
df_group_counts <- df_data_sorted %>%
  group_by(group_sorter_desc, group_sorter) %>%
  summarize(group_count = n()) %>%
  arrange(group_sorter) %>% ungroup() %>%
  mutate(group_count_start = cumsum(group_count) - group_count + 1) %>%
  mutate(group_count_end = cumsum(group_count)) %>%
  select(group_count_start, group_count_end, everything())
# display
kable(df_group_counts, caption="Group counter")
```

Format columns, decimals, percentage signs, etc.

```{r}
# 4. Format columns, decimals, percentage signs, etc
df_data_formatted <- df_data_sorted %>%
  arrange(group_sorter, country_name) %>%
  select(
      country_name, 
      pchg_itp_cnt_youthpop, pchg_raw_shr_youthpop,
      pchg_itp_cnt_student, pchg_raw_shr_student,
      pchg_itp_cnt_teacher, pchg_raw_shr_teacher,
      pchg_itp_cnt_school, pchg_raw_shr_school
    ) %>%
  mutate_at(
    vars(contains("shr")),
    list(~ paste0(
      format(round(., 2) * 100,
        nsmall = 0,
        big.mark = ","
      ),
      "%"
    ))
  ) %>%
  mutate_at(
    vars(contains("cnt")),
    list(~ paste0(.))
  )
df_data_formatted <- df_data_formatted %>%
  mutate_at(vars(contains("shr")), ~ str_replace(., "NA%", "")) %>%
  mutate_at(vars(contains("cnt")), ~ str_replace(., "NA", ""))
```

Generate table. Also see [res-tab/country_interpolate.tex](https://github.com/FanWangEcon/PrjCompPPTS/tree/master/res-tab/country_interpolate.tex).

```{r}
ar_st_kableformat <- c("html", "latex")
ar_st_kableformat <- c("html")
for (st_kableformat in ar_st_kableformat) {
  # Column names
  ar_st_col_names <- c(
    "Country name",
    "Obs yrs",
    "Perc. of yrs with admin data",
    "Obs yrs",
    "Perc. of yrs with admin data",
    "Obs yrs",
    "Perc. of yrs with admin data",
    "Obs yrs",
    "Perc. of yrs with admin data"
  )
  # Define column groups, grouping the names above
  # =1/3/2 are number of columns group title covers
  ar_st_col_groups1 <- c(
    " " = 1,
    "Youth population" = 2,
    "Students" = 2,
    "Teachers" = 2,
    "Schools" = 2
  )
  # Second, we construct main table, and add styling.
  st_title <- paste(
    "Share of country-specific data generated through interpolation and extrapolation"
    )
  bk_tab_a <- kbl(
    df_data_formatted,
    format = st_kableformat,
    label = "tab:lac:aod:temp:rank",
    # escape = F,
    linesep = "",
    booktabs = T,
    longtable = T,
    align = "c",
    caption = st_title,
    col.names = ar_st_col_names
  ) %>%
    # see https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#Bootstrap_table_classes
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = F, position = "left"
    )
  # Third, we add in column groups.
  bk_tab_a <- bk_tab_a %>%
    add_header_above(ar_st_col_groups1)
  # Fourth, we add in row groups.
  for (it_group in seq(1, dim(df_group_counts)[1])) {
    # Reion full name info
    st_loc <- as.character(df_group_counts[[it_group, "group_sorter_desc"]])
    # groups start and end
    it_group_count_start <- df_group_counts[[it_group, "group_count_start"]]
    it_group_count_end <- df_group_counts[[it_group, "group_count_end"]]
    # display text
    st_panel_letter <- base::LETTERS[it_group]
    # Heading group row, year
    st_panel_text <- paste0(
      "Panel ", st_panel_letter, ": ", st_loc 
    )
    # Add to table
    bk_tab_a <- bk_tab_a %>%
      pack_rows(
        st_panel_text, it_group_count_start, it_group_count_end,
        latex_gap_space = "0.25em",
        latex_align = "c",
        hline_after = TRUE
      )
  }
  # Fifth, column formatting.
  fl_width_country <- 6
  st_width_country <- paste0(fl_width_country, "cm")
  bk_tab_a <- bk_tab_a %>%
    column_spec(1, width = st_width_country) %>%
    column_spec(2:dim(df_data_formatted)[2], width = "3cm")
  # Final adjustments
  # Headings on all pages, note use `sub` to replace first midrule
  st_headend <- paste0(
    "\\midrule\\endhead\n",
    "\\addlinespace[0.2em]\\hline\\addlinespace[0.2em]\n",
    "\\multicolumn{", dim(df_data_formatted)[2], "}{r}{\\emph{Continued on next page}}\\\\\n",
    "\\endfoot\\endlastfoot"
  )
  bk_tab_a <- sub(bk_tab_a,
    pattern = "\\midrule", replacement = st_headend,
    fixed = TRUE
  )

  # country-names left-align
  bk_tab_a <- gsub(bk_tab_a,
    pattern = paste0("\\centering\\arraybackslash}p{", st_width_country, "}"),
    replacement = paste0("\\raggedright\\arraybackslash}p{", st_width_country, "}"),
    fixed = TRUE
  )
  bk_tab_a <- gsub(bk_tab_a,
    pattern = paste0("\\$\\textasciicircum{}\\{\\textbackslash{}circ\\}C\\$"),
    replacement = paste0("$^{\\circ}C$"),
    fixed = TRUE
  )
  bk_tab_a <- gsub(bk_tab_a,
    pattern = paste0("\\$\\textbackslash{}ge\\$"),
    replacement = paste0("$\\ge$"),
    fixed = TRUE
  )
  st_text <- ""
  bk_tab_a <- gsub(bk_tab_a,
    pattern = paste0("\\textbackslash{}", st_text, "\\"),
    replacement = paste0("\\", st_text),
    fixed = TRUE
  )
  # midrule replacing hline
  bk_tab_a <- gsub(bk_tab_a,
    pattern = "hline",
    replacement = "midrule", fixed = TRUE
  )

  # 6. Finally, save table content to file
  if (st_kableformat == "latex") {
    if (bl_tex_save) {
      fileConn <- file(spn_tex_out)
      writeLines(bk_tab_a, fileConn)
      close(fileConn)
      if (verbose) {
        print(glue::glue("F-815346, S3"))
        print(glue::glue("Latex saved: {spn_tex_out}"))
      }
    }
  } else if (st_kableformat == "html") {
    bk_tab_a_html <- bk_tab_a
  }
}
bk_tab_a_html
```

## Selected country results 

We will have two variables, the variable with the interpolated results along with original raw data, as well as a variable with just the points where interpolation took place. And we will visualize by presenting the full results as a solid line, and the places where interpolation and extrapolation took place as dots. 

```{r}
ppts_pchg <- ppts_pchg %>% 
  select(
    location_code, 
    variable, year, 
    value, value_interp1
  ) %>%
  mutate(
    value_interponly = case_when(
      is.na(value) & !is.na(value_interp1) ~ value_interp1,
      TRUE ~ NA
    )
  )
```

Interpolated and raw data in the same variable for easier graphing. 

```{r}
ppts_pchg_longer <- ppts_pchg %>% 
  select(
    location_code, 
    variable, year, 
    value, value_interp1, value_interponly
  ) %>%
  rename(
    value_0raw = value, 
    value_1interp1 = value_interp1, 
    value_2interpoly = value_interponly
    ) %>%
  pivot_longer(cols = starts_with('value'),
              names_to = c('value_type'),
              names_pattern = paste0("value_(.*)"),
              values_to = "value") %>% 
  drop_na(value)
print(
  ppts_pchg_longer %>% group_by(value_type) %>% tally()
  )
```

### Graph-generating script

Build a graph generating function to show all data points and interpolated points. 

```{r}
ffi_select_country_show_interpolate <- function(
  st_country_name = "France"
) {
  # Select
  st_location_code <- ppts_country_code_sel %>% 
    filter(location_name == st_country_name) %>% 
    pull(location_code)
  ppts_pchg_longer_country <- ppts_pchg_longer %>% 
    filter(location_code == st_location_code)
  ppts_pchg_country <- ppts_pchg %>% 
    filter(location_code == st_location_code)

  # Visualize.
  # Color controls
  ar_st_colors <- c("#33cc33", "#F8766D")
  ar_st_labels <- c("Admin data", "Interp.-extrap.")
  # Shape controls
  ar_it_shapes <- c(1, 5)

  pl_lines_pri <- ggplot() + 
    geom_point(
      data = ppts_pchg_longer_country %>% filter(value_type != "1interp1"),
      aes(
        x=year, y=value, 
        color=value_type, shape=value_type,
      ), size = 2) + 
    geom_line(
      data= ppts_pchg_longer_country %>% filter(value_type == "1interp1"),
      aes(
        x=year, y=value
        ), linewidth = 0.5, color="gray") + 
    facet_wrap( ~ 
      factor(variable, c("youthpop", "student", "teacher", "school")),
      scales = "free_y"
    ) + 
    labs(x = paste0("Years"),
        y = paste0("Number people or schools"),
        title = paste(
          st_country_name,
          ": youth (age 0 to 15), primary students, teachers, and schools", 
          sep=" "),
        subtitle = paste(
          "Compare data points from administrative datasets",
          "with interpolated and extrapolated data", sep=" "),
        caption = paste(
          "Hannum, Kim and Wang (2024)", sep="")) + 
    scale_color_manual(values = ar_st_colors, labels=ar_st_labels) +
    scale_shape_manual(values = ar_it_shapes, labels=ar_st_labels) + 
    scale_y_continuous(labels = scales::comma_format(big.mark = ',')) + 
    theme(
      text = element_text(size = 11),
      legend.title = element_blank(),
      legend.position = c(0.90, 0.90),
      legend.key.width = unit(1.5, "line"),
      legend.background =
        element_rect(fill = "transparent", colour = "black", linetype='solid')
    )
  return(pl_lines_pri)        
}
```


### Administrative data and interpolation in East Asia

```{r}
ar_st_country_name <- c(
  "China", "Japan", "Korea, Rep.", "Taiwan"
)
for (st_country_name in ar_st_country_name) {
  pl_country <- ffi_select_country_show_interpolate(st_country_name = st_country_name)
  print(pl_country)
}
```

### Administrative data and interpolation in Western Europe

```{r}
ar_st_country_name <- c(
  "Austria", "Germany", "France", "Netherlands", "Switzerland"
)
for (st_country_name in ar_st_country_name) {
  pl_country <- ffi_select_country_show_interpolate(st_country_name = st_country_name)
  print(pl_country)
}
```
