---
title: "Table: Western Europe East Asia youth, students, teachers, and schools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Table: Western Europe East Asia youth, students, teachers, and schools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tibble)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(kableExtra)

library(PrjCompPPTS)
# If resave outputs to data, only do this during development
# Latex output file
verbose <- TRUE
bl_tex_save <- TRUE
spt_path_res <- file.path("..", "res-tab", fsep = .Platform$file.sep)
spn_tex_out <- file.path(spt_path_res, "tab_weea_lrce.tex", fsep = .Platform$file.sep)
```

[Implement PrjCompPPTS-11](https://github.com/FanWangEcon/PrjCompPPTS/issues/11),summaries for Western Europe and East Asia stats.

## Generate input file 

### Load prepped all location level files

Load file with interpolated data. 

```{r}
# Locaiton codes
ppts_code_wrk <- ppts_country_code
# We load in the global population data.
df_ppts <- ppts_easia_weuro_world_pchg
```

### Run PrjCompPPTS functions

Run functions to generate FLR, FPC, and FEL files. Run FLR. 

```{r}
# country list
ar_st_country_names <- c(
  "CHN", "TWN", "JPN", "KOR",
  "AUT", "DEU", "FRA", "NLD", "CHE"
)
df_ppts_sel <- df_ppts %>%
  filter(location_code %in% ar_st_country_names)
# Generate PLR
df_flr_weea <- PrjCompPPTS::ff_ppts_lrce_flr(
  df_ppts_sel,
  st_year_bins_type = "1940t2020i01",
  ar_it_years = c(
    1960, 1970, 1980, 1990, 2000, 2010, 2020
  ),
  verbose = TRUE
)
```

Run FPC.

```{r}
# Generate FPC
df_fpc_weea <- PrjCompPPTS::ff_ppts_lrce_fpc(
  df_flr_weea,
  ar_it_years_chg = c(1960, 1970, 1980, 1990, 2000, 2010, 2020),
  ls_chg_years = list(
    "chg_20v60" = c(1960, 2020),
    "chg_20v70" = c(1970, 2020),
    "chg_20v80" = c(1980, 2020),
    "chg_20v90" = c(1990, 2020),
    "chg_20v00" = c(2000, 2020),
    "chg_20v10" = c(2010, 2020)
  ), verbose = TRUE
)
print(df_fpc_weea, n = 40)
```

Run FEL. 

```{r}
# Generate FEL
df_fel_weea <- PrjCompPPTS::ff_ppts_lrce_fel(
  df_fpc_weea,
  verbose = TRUE
)
print(df_fel_weea, n = 40)
```

### Merge FPC and FEL, country and group

Now we combine the level and change information from FPC with the elasticity results from FEL. 

We have the LRCE file, level, ratio, change, and elasticity.

```{r}
df_lrce_weea <- df_fpc_weea %>% left_join(
  df_fel_weea %>% mutate(vartype = "rat"),
  by = (c(
    "location_code" = "location_code",
    "location_level" = "location_level",
    "variable" = "variable",
    "vartype" = "vartype"
  ))
)
print(glue::glue("dim df_lrce_weea: {dim(df_lrce_weea)}"))
```

Finally, merge in country key info to FPC, country-level information.

```{r}
df_lrce_weea <- df_lrce_weea %>%
  left_join(
    ppts_code_wrk %>%
      select(
        location_name, location_code,
        location_region_group, location_region_group_code
      ),
    by = c("location_code" = "location_code")
  ) %>%
  # mutate(location_name_full = paste0(location_name, " (", location_code, ")")) %>%
  mutate(location_name_full = paste0(location_name)) %>%
  select(-location_name) %>%
  select(location_name_full, location_region_group, everything()) %>%
  arrange(location_region_group_code, location_name_full)
```

## Global Population Table

### Prep Table inputs

First, select level and percentage changes year by year for four variables. Also get ratio and elasticities.

```{r}
# level
df_lvl_weea <- df_lrce_weea %>%
  filter(vartype == "lvl") %>%
  select(location_name_full, variable, contains("year"))
# change
df_chg_weea <- df_lrce_weea %>%
  filter(vartype == "lvl") %>%
  select(location_name_full, variable, contains("chg"))
# ratio
df_rat_weea <- df_lrce_weea %>%
  filter(vartype == "rat") %>%
  select(location_name_full, variable, contains("year"))
# elasticity
df_elas_weea <- df_lrce_weea %>%
  filter(vartype == "rat") %>%
  select(location_name_full, variable, contains("elas"))
```

Second, reshape time variables from each table above from wide to long. 

```{r}
# level file
df_lvl_weea_long <- df_lvl_weea %>%
  pivot_longer(
    cols = starts_with("year"),
    names_to = c("yearset"),
    names_pattern = paste0("year(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "1lvl")
# change file
df_chg_weea_long <- df_chg_weea %>%
  pivot_longer(
    cols = starts_with("chg"),
    names_to = c("yearset"),
    names_pattern = paste0("chg_(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "2chg")
# ratio file
df_rat_weea_long <- df_rat_weea %>%
  pivot_longer(
    cols = starts_with("year"),
    names_to = c("yearset"),
    names_pattern = paste0("year(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "3rat")
# elasticity file
df_elas_weea_long <- df_elas_weea %>%
  pivot_longer(
    cols = starts_with("elas"),
    names_to = c("yearset"),
    names_pattern = paste0("elas_(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "4elas")
```

Third, combine long files, and convert countries to columns, reshape to wide.

```{r}
# combine all long files
df_weea_long_jnt <- bind_rows(
  df_lvl_weea_long,
  df_chg_weea_long,
  df_rat_weea_long,
  df_elas_weea_long
)
# country name modification
df_weea_long_jnt <- df_weea_long_jnt %>%
  mutate(
    location_name_full =
      ifelse(location_name_full == "Korea, Rep.", "Korea", location_name_full)
  )
# reshape long to wide
df_weea_wide <- df_weea_long_jnt %>%
  pivot_wider(
    id_cols = c("type", "variable", "yearset"),
    names_from = location_name_full,
    names_prefix = "j_",
    values_from = stats
  )
```

Fourth, organize columns, and generate four subsets.

```{r}
# Select variables
tab3_weea <- df_weea_wide %>%
  select(
    type, variable, yearset,
    j_China, j_Japan, j_Korea, j_Taiwan,
    j_Austria, j_Germany, j_France, j_Netherlands, j_Switzerland
  )
# Four variables
tab3_weea_lvl <- tab3_weea %>% filter(type == "1lvl")
tab3_weea_chg <- tab3_weea %>% filter(type == "2chg")
tab3_weea_rat <- tab3_weea %>% filter(type == "3rat")
tab3_weea_elas <- tab3_weea %>% filter(type == "4elas")
```

Fifth, format each type of variables separately.

```{r}
# Format variables, level in millions
tab3_weea_lvl_school <- tab3_weea_lvl %>%
  filter(variable == "school") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(. / 1000, 1),
        nsmall = 0, big.mark = ","
      )
    ))
  )
tab3_weea_lvl_teacher <- tab3_weea_lvl %>%
  filter(variable == "teacher") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(. / 1000, 1),
        nsmall = 0, big.mark = ","
      )
    ))
  )
tab3_weea_lvl_youth <- tab3_weea_lvl %>%
  filter(variable == "youthpop") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(. / 1000000, 1),
        nsmall = 0, big.mark = ","
      )
    ))
  )
tab3_weea_lvl_student <- tab3_weea_lvl %>%
  filter(variable == "student") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(. / 1000000, 1),
        nsmall = 0, big.mark = ","
      )
    ))
  )
# Change in percent
tab3_weea_chg <- tab3_weea_chg %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 2) * 100,
        nsmall = 0,
        big.mark = ","
      ),
      "%"
    ))
  )
# Change in ratio
tab3_weea_rat <- tab3_weea_rat %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 0), nsmall = 0, big.mark = ",")
    ))
  )
# Change in ratio
tab3_weea_elas <- tab3_weea_elas %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 2), nsmall = 0, big.mark = ",")
    ))
  )
```

Sixth, combine all four stats again, now that formatting is done.

```{r}
# combine
tab3_weea_jnt <- bind_rows(
  tab3_weea_lvl_school,
  tab3_weea_lvl_teacher,
  tab3_weea_lvl_youth,
  tab3_weea_lvl_student,
  tab3_weea_chg,
  tab3_weea_rat,
  tab3_weea_elas
)
# replace variable names for sorting
tab3_weea_jnt <- tab3_weea_jnt %>%
  mutate(variable_sort = case_when(
    variable == "school" ~ "1school",
    variable == "teacher" ~ "2teacher",
    variable == "student" ~ "3student",
    variable == "youthpop" ~ "4youthpop",
    variable == "s2s" ~ "1s2s",
    variable == "y2s" ~ "2y2s",
    variable == "s2t" ~ "3s2t",
    variable == "y2t" ~ "4y2t"
  ))
# Year sorting
tab3_weea_jnt <- tab3_weea_jnt %>%
  mutate(yearset = case_when(
    yearset == "20v00" ~ "2020 vs 2000",
    yearset == "20v10" ~ "2020 vs 2010",
    yearset == "20v60" ~ "2020 vs 1960",
    yearset == "20v70" ~ "2020 vs 1970",
    yearset == "20v80" ~ "2020 vs 1980",
    yearset == "20v90" ~ "2020 vs 1990",
    TRUE ~ yearset
  ))
# replace NAs
tab3_weea_jnt <- tab3_weea_jnt %>%
  mutate_at(vars(starts_with("j_")), ~ str_replace(., "NA%", "")) %>%
  mutate_at(vars(starts_with("j_")), ~ str_replace(., "NA", ""))

print(tab3_weea_jnt, n = 200)
```

Finally, count by group, generate labeling string

```{r}
# Group and arrange
tab3_weea_jnt <- tab3_weea_jnt %>%
  arrange(
    type, variable_sort, yearset,
  )
# get counts
df_typevar_counts <- tab3_weea_jnt %>%
  group_by(
    type, variable_sort, variable,
  ) %>%
  summarize(group_count = n()) %>%
  ungroup() %>%
  mutate(group_count_start = cumsum(group_count) - group_count + 1) %>%
  mutate(group_count_end = cumsum(group_count)) %>%
  select(group_count_start, group_count_end, everything())
# Generate group names
df_typevar_counts <- df_typevar_counts %>%
  mutate(type_lab = case_when(
    type == "1lvl" ~ "Number of",
    type == "2chg" ~ "Percentage change in",
    type == "3rat" ~ "Ratio",
    type == "4elas" ~ "Elasticity"
  )) %>%
  mutate(variable_lab = case_when(
    (type == "1lvl" & variable == "school") ~ "schools (1000s)",
    (type == "1lvl" & variable == "teacher") ~ "teachers (1000s)",
    (type == "1lvl" & variable == "student") ~ "students (mil.)",
    (type == "1lvl" & variable == "youthpop") ~ "youth 0-14 (mil.)",
    (type == "2chg" & variable == "school") ~ "schools",
    (type == "2chg" & variable == "teacher") ~ "teachers",
    (type == "2chg" & variable == "student") ~ "students",
    (type == "2chg" & variable == "youthpop") ~ "youth 0-14",
    (type == "3rat" & variable == "s2s") ~ "Student/School",
    (type == "3rat" & variable == "y2s") ~ "Youth/School",
    (type == "3rat" & variable == "s2t") ~ "Student/Teacher",
    (type == "3rat" & variable == "y2t") ~ "Youth/Teacher",
    (type == "4elas" & variable == "s2s") ~ "$\\Delta$\\%Student/$\\Delta$\\%School",
    (type == "4elas" & variable == "y2s") ~ "$\\Delta$\\%Youth/$\\Delta$\\%School",
    (type == "4elas" & variable == "s2t") ~ "$\\Delta$\\%Student/$\\Delta$\\%Teacher",
    (type == "4elas" & variable == "y2t") ~ "$\\Delta$\\%Youth/$\\Delta$\\%Teacher"
  )) %>%
  unite(row_name, type_lab:variable_lab, sep = " ")
# print
print(df_typevar_counts, n = 100)
```


### Generate table 

Now we generate the table. 

```{r}
ar_st_kableformat <- c("latex", "html")
for (st_kableformat in ar_st_kableformat) {
  # j_China, j_Japan, j_Korea, j_Taiwan,
  # j_Austria, j_Germany, j_France, j_Netherlands, j_Switzerland
  # Column names
  ar_st_col_names <- c(
    "Years",
    "China",
    "Japan",
    "Korea",
    "Taiwan",
    "Austria",
    "Germany",
    "France",
    "Netherlands",
    "Switzerland"
  )
  # Define column groups, grouping the names above
  # =1/3/2 are number of columns group title covers
  ar_st_col_groups <- c(
    " " = 1,
    "East Asia" = 4,
    "Western Europe" = 5
  )

  # Second, we construct main table, and add styling.
  bk_weea <- kbl(
    tab3_weea_jnt %>%
      select(-type, -variable, -variable_sort),
    format = st_kableformat,
    label = "main:tab:weaa:pop:teachers:schools",
    # escape = F,
    linesep = "",
    booktabs = T,
    longtable = T,
    align = "c",
    caption = "East Asia and Western Europe: Schools, Teachers, Students, and Youth",
    col.names = ar_st_col_names
  ) %>%
    # see https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#Bootstrap_table_classes
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = F, position = "left"
    )

  # Third, we add in column groups.
  bk_weea <- bk_weea %>% add_header_above(ar_st_col_groups)

  # Fourth, we add in row groups.
  for (it_group in seq(1, dim(df_typevar_counts)[1])) {
    # Reion full name info
    st_loc <- as.character(df_typevar_counts[[it_group, "row_name"]])

    # groups start and end
    it_group_count_start <- df_typevar_counts[[it_group, "group_count_start"]]
    it_group_count_end <- df_typevar_counts[[it_group, "group_count_end"]]

    # Add to table
    bk_weea <- bk_weea %>%
      pack_rows(
        st_loc, it_group_count_start, it_group_count_end,
        latex_gap_space = "1em",
        latex_align = "c",
        hline_after = TRUE
      )
  }

  # Fifth, column formatting.
  fl_width_country <- 1.5
  st_width_country <- paste0(fl_width_country, "cm")
  bk_weea <- bk_weea %>%
    column_spec(1, width = st_width_country) %>%
    column_spec(2:10, width = "1.0cm")

  # Final adjustments
  # Headings on all pages, note use `sub` to replace first midrule
  st_headend <- paste0(
    "\\midrule\\endhead\n",
    "\\addlinespace[0.2em]\\hline\\addlinespace[0.2em]\n",
    "\\multicolumn{10}{r}{\\emph{Continued on next page}}\\\\\n",
    "\\endfoot\\endlastfoot"
  )
  bk_weea <- sub(bk_weea,
    pattern = "\\midrule", replacement = st_headend,
    fixed = TRUE
  )
  # country-names left-align
  bk_weea <- gsub(bk_weea,
    pattern = paste0("\\centering\\arraybackslash}p{", st_width_country, "}"),
    replacement = paste0("\\raggedright\\arraybackslash}p{", st_width_country, "}"),
    fixed = TRUE
  )
  # midrule replacing hline
  bk_weea <- gsub(bk_weea,
    pattern = "hline",
    replacement = "midrule", fixed = TRUE
  )

  # Sixth, display.
  # pl_bk_asset_count <- bk_asset_count %>% as_image()
  if (st_kableformat == "html") {
    print(dim(bk_weea))
  } else {
    if (bl_tex_save) {
      fileConn <- file(spn_tex_out)
      writeLines(bk_weea, fileConn)
      close(fileConn)
      if (verbose) {
        print(glue::glue("F-945386, S1"))
        print(glue::glue("Latex saved: {spn_tex_out}"))
      }
    }
  }
}
bk_weea
```
