---
title: "Table: Korea youth, students, teachers, and schools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Table: Korea youth, students, teachers, and schools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tibble)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(kableExtra)

library(PrjCompPPTS)
# If resave outputs to data, only do this during development
bl_tex_save <- TRUE
verbose <- TRUE

# Latex output file
spt_path_res <- file.path("..", "res-tab", fsep = .Platform$file.sep)
spn_tex_out <- file.path(spt_path_res, "tab_korea_lrce.tex", fsep = .Platform$file.sep)
```

[Implement PrjCompPPTS-13](https://github.com/FanWangEcon/PrjCompPPTS/issues/13), summaries for Korea.

## Generate input file 

### Load prepped all location level files

Load file with interpolated data. 

```{r}
# Locaiton codes
ppts_code_wrk <- ppts_country_code
# We load in the global population data.
df_ppts <- ppts_easia_weuro_world_pchg
```

```{r}
# location level types
df_ppts %>% distinct(location_level)
df_ppts_sel <- df_ppts %>%
  filter(location_level %in% c("province", "multiprovince"))

# Show all Korean locations
df_ppts_sel %>% distinct(location_code)
df_ppts_sel %>% distinct(variable)

# Korean locations into three groups
ls_korea <- list(
  "KOR_Metro" = c("A1-Metro", "Location groups"),
  "KOR_NonMetro" = c("C1-Non-metro", "Location groups"),
  "KOR_Gyeong-gi" = c("A4-Gyeong-gi", "Capital"),
  "KOR_Incheon" = c("A3-Incheon", "Capital"),
  "KOR_Seoul" = c("A2-Seoul", "Capital"),
  "KOR_Busan" = c("B1-Busan", "Metropolitan cities"),
  "KOR_Daegu" = c("B2-Daegu", "Metropolitan cities"),
  "KOR_Daejeon" = c("B3-Daejeon", "Metropolitan cities"),
  "KOR_Gwangju" = c("B4-Gwangju", "Metropolitan cities"),
  "KOR_Sejong" = c("B5-Sejong", "Metropolitan cities"),
  "KOR_Ulsan" = c("B6-Ulsan", "Metropolitan cities"),
  "KOR_Chungbuk" = c("D1-Chungbuk", "Non-metropolitan cities"),
  "KOR_Chungnam" = c("D2-Chungnam", "Non-metropolitan cities"),
  "KOR_Gyeongbuk" = c("D3-Gyeongbuk", "Non-metropolitan cities"),
  "KOR_Gyeongnam" = c("D4-Gyeongnam", "Non-metropolitan cities"),
  "KOR_Jeonnam" = c("D5-Jeonnam", "Non-metropolitan cities"),
  "KOR_Gangwon" = c("E1-Gangwon", "Non-metropolitan cities"),
  "KOR_Jeju" = c("E2-Jeju", "Non-metropolitan cities"),
  "KOR_Jeonbuk" = c("E3-Jeonbuk", "Non-metropolitan cities")
)
```

### Run PrjCompPPTS functions

Run functions to generate FLR, FPC, and FEL files. Run FLR. 
```{r}
# Generate PLR
df_flr_korea <- PrjCompPPTS::ff_ppts_lrce_flr(
  df_ppts_sel,
  st_year_bins_type = "1940t2020i01",
  ar_it_years = seq(1970, 2020, by = 10),
  # c(1970, 1980, 1990, 2000, 2010, 2020),
  ar_st_vars = c("student", "teacher", "school"),
  ls_rat_vars = list(
    "s2t" = c("student", "teacher"),
    "s2s" = c("student", "school")
  ),
  verbose = TRUE
)
df_flr_korea %>% distinct(year_bins)
```

Run FPC.

```{r}
# Generate FPC
df_fpc_korea <- PrjCompPPTS::ff_ppts_lrce_fpc(
  df_flr_korea,
  ar_it_years_chg = seq(1970, 2020, by = 10),
  ls_chg_years = list(
    "chg_20v70" = c(1970, 2020),
    # "chg_20v75" = c(1975, 2020),
    "chg_20v80" = c(1980, 2020),
    # "chg_20v85" = c(1985, 2020),
    "chg_20v90" = c(1990, 2020),
    # "chg_20v95" = c(1995, 2020),
    "chg_20v00" = c(2000, 2020),
    # "chg_20v05" = c(2005, 2020),
    "chg_20v10" = c(2010, 2020)
    # "chg_20v15" = c(2015, 2020)
  ), verbose = TRUE
)
print(df_fpc_korea, n = 40)
```

Run FEL. 

```{r}
# Generate FEL
df_fel_korea <- PrjCompPPTS::ff_ppts_lrce_fel(
  df_fpc_korea,
  ls_rat_vars = list(
    # "y2t" = c("youthpop", "teacher"),
    "s2t" = c("student", "teacher"),
    # "y2s" = c("youthpop", "school"),
    "s2s" = c("student", "school")
  ),
  verbose = TRUE
)
print(df_fel_korea, n = 40)
```

### Merge FPC and FEL, country and group

Now we combine the level and change information from FPC with the elasticity results from FEL. 

We have the LRCE file, level, ratio, change, and elasticity.

```{r}
df_lrce_korea <- df_fpc_korea %>% left_join(
  df_fel_korea %>% mutate(vartype = "rat"),
  by = (c(
    "location_code" = "location_code",
    "location_level" = "location_level",
    "variable" = "variable",
    "vartype" = "vartype"
  ))
)
print(glue::glue("dim df_lrce_korea: {dim(df_lrce_korea)}"))
```

Finally, merge in country key info to FPC, country-level information.

```{r}
# Create empty columns
df_lrce_korea <- df_lrce_korea %>%
  mutate(location_name = "", location_region_group = "")
# Add content to dataframe
it_len_ls_korea <- length(ls_korea)
ar_st_locs <- names(ls_korea)
for (it_loc in seq(1, it_len_ls_korea)) {
  # Get strings
  st_location_code <- ar_st_locs[it_loc]
  ar_st_location_display <- ls_korea[[it_loc]]
  st_loc_name_disp <- ar_st_location_display[[1]]
  st_loc_group <- ar_st_location_display[[2]]
  # Add values
  df_lrce_korea <- df_lrce_korea %>%
    mutate(
      location_name = case_when(
        location_code == st_location_code ~ st_loc_name_disp,
        TRUE ~ location_name
      ),
      location_region_group = case_when(
        location_code == st_location_code ~ st_loc_group,
        TRUE ~ location_region_group
      )
    )
}
# reselect vars
df_lrce_korea <- df_lrce_korea %>%
  select(location_code, location_level, location_name, location_region_group, everything())
```

## Global Population Table

### Prep Table inputs

First, select level and percentage changes year by year for four variables. Also get ratio and elasticities.

```{r}
# level
df_lvl_korea <- df_lrce_korea %>%
  filter(vartype == "lvl") %>%
  select(
    location_code, location_level, location_name, location_region_group,
    variable, contains("year")
  )
# change
df_chg_korea <- df_lrce_korea %>%
  filter(vartype == "lvl") %>%
  select(
    location_code, location_level, location_name, location_region_group,
    variable, contains("chg")
  )
# ratio
df_rat_korea <- df_lrce_korea %>%
  filter(vartype == "rat") %>%
  select(
    location_code, location_level, location_name, location_region_group,
    variable, contains("year")
  )
# elasticity
df_elas_korea <- df_lrce_korea %>%
  filter(vartype == "rat") %>%
  select(
    location_code, location_level, location_name, location_region_group,
    variable, contains("elas")
  )
```

Second, reshape time variables from each table above from wide to long. 

```{r}
# level file
df_lvl_korea_long <- df_lvl_korea %>%
  pivot_longer(
    cols = starts_with("year"),
    names_to = c("yearset"),
    names_pattern = paste0("year(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "1lvl")
# change file
df_chg_korea_long <- df_chg_korea %>%
  pivot_longer(
    cols = starts_with("chg"),
    names_to = c("yearset"),
    names_pattern = paste0("chg_(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "2chg")
# ratio file
df_rat_korea_long <- df_rat_korea %>%
  pivot_longer(
    cols = starts_with("year"),
    names_to = c("yearset"),
    names_pattern = paste0("year(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "3rat")
# elasticity file
df_elas_korea_long <- df_elas_korea %>%
  pivot_longer(
    cols = starts_with("elas"),
    names_to = c("yearset"),
    names_pattern = paste0("elas_(.*)"),
    values_to = "stats"
  ) %>%
  mutate(type = "4elas")
```

Third, combine long files, and convert countries to columns, reshape to wide.

```{r}
# combine all long files
df_korea_long_jnt <- bind_rows(
  df_lvl_korea_long,
  df_chg_korea_long,
  df_rat_korea_long,
  df_elas_korea_long
)
# reshape long to wide
df_korea_wide <- df_korea_long_jnt %>%
  arrange(variable, yearset, location_name) %>%
  pivot_wider(
    id_cols = c("type", "variable", "yearset"),
    names_from = location_name,
    names_prefix = "j_",
    values_from = stats
  )
```

Fourth, organize columns, and generate four subsets.

```{r}
# Select variables
tab3_korea <- df_korea_wide %>%
  select(
    type, variable, yearset, everything()
  )
# Four variables
tab3_korea_lvl <- tab3_korea %>% filter(type == "1lvl")
tab3_korea_chg <- tab3_korea %>% filter(type == "2chg")
tab3_korea_rat <- tab3_korea %>% filter(type == "3rat")
tab3_korea_elas <- tab3_korea %>% filter(type == "4elas")
```

Fifth, format each type of variables separately.

```{r}
# Format variables, level in millions
tab3_korea_lvl_school <- tab3_korea_lvl %>%
  filter(variable == "school") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 0),
        nsmall = 0, big.mark = ","
      )
    ))
  )
tab3_korea_lvl_teacher <- tab3_korea_lvl %>%
  filter(variable == "teacher") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(. / 1000, 1),
        nsmall = 0, big.mark = ","
      )
    ))
  )
tab3_korea_lvl_student <- tab3_korea_lvl %>%
  filter(variable == "student") %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(. / 1000, 0),
        nsmall = 0, big.mark = ","
      )
    ))
  )
# Change in percent
tab3_korea_chg <- tab3_korea_chg %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 2) * 100,
        nsmall = 0,
        big.mark = ","
      ),
      "%"
    ))
  )
# Change in ratio
tab3_korea_rat <- tab3_korea_rat %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 0), nsmall = 0, big.mark = ",")
    ))
  )
# Change in ratio
tab3_korea_elas <- tab3_korea_elas %>%
  mutate_at(
    vars(contains("j_")),
    list(~ paste0(
      format(round(., 2), nsmall = 0, big.mark = ",")
    ))
  )
```

Sixth, combine all four stats again, now that formatting is done.

```{r}
# combine
tab3_korea_jnt <- bind_rows(
  tab3_korea_lvl_school,
  tab3_korea_lvl_teacher,
  tab3_korea_lvl_student,
  tab3_korea_chg,
  tab3_korea_rat,
  # tab3_korea_elas
)
# replace variable names for sorting
tab3_korea_jnt <- tab3_korea_jnt %>%
  mutate(variable_sort = case_when(
    variable == "school" ~ "1school",
    variable == "teacher" ~ "2teacher",
    variable == "student" ~ "3student",
    variable == "s2s" ~ "1s2s",
    variable == "s2t" ~ "3s2t",
  ))
# Year sorting
tab3_korea_jnt <- tab3_korea_jnt %>%
  mutate(yearset = case_when(
    yearset == "20v00" ~ "2020 vs 2000",
    yearset == "20v10" ~ "2020 vs 2010",
    yearset == "20v60" ~ "2020 vs 1960",
    yearset == "20v70" ~ "2020 vs 1970",
    yearset == "20v80" ~ "2020 vs 1980",
    yearset == "20v90" ~ "2020 vs 1990",
    TRUE ~ yearset
  ))
# replace NAs
tab3_korea_jnt <- tab3_korea_jnt %>%
  mutate_at(vars(starts_with("j_")), ~ str_replace(., "NA%", "")) %>%
  mutate_at(vars(starts_with("j_")), ~ str_replace(., "NA", ""))

print(tab3_korea_jnt, n = 200)
```

Finally, count by group, generate labeling string

```{r}
# Group and arrange
tab3_korea_jnt <- tab3_korea_jnt %>%
  arrange(
    type, variable_sort, yearset,
  )
# get counts
df_typevar_counts <- tab3_korea_jnt %>%
  group_by(
    type, variable_sort, variable,
  ) %>%
  summarize(group_count = n()) %>%
  ungroup() %>%
  mutate(group_count_start = cumsum(group_count) - group_count + 1) %>%
  mutate(group_count_end = cumsum(group_count)) %>%
  select(group_count_start, group_count_end, everything())
# Generate group names
df_typevar_counts <- df_typevar_counts %>%
  mutate(type_lab_supra = case_when(
    type == "1lvl" ~ "Levels",
    type == "2chg" ~ "Percentage changes over time",
    type == "3rat" ~ "Ratios",
    type == "4elas" ~ "Elasticities"
  )) %>%
  mutate(type_lab = case_when(
    type == "1lvl" ~ "Number of",
    type == "2chg" ~ "Percentage change in",
    type == "3rat" ~ "Ratio",
    type == "4elas" ~ "Elasticity"
  )) %>%
  mutate(variable_lab = case_when(
    (type == "1lvl" & variable == "school") ~ "schools",
    (type == "1lvl" & variable == "teacher") ~ "teachers (1000s)",
    (type == "1lvl" & variable == "student") ~ "students (1000s)",
    (type == "2chg" & variable == "school") ~ "schools",
    (type == "2chg" & variable == "teacher") ~ "teachers",
    (type == "2chg" & variable == "student") ~ "students",
    (type == "2chg" & variable == "youthpop") ~ "youth 0-14",
    (type == "3rat" & variable == "s2s") ~ "Student/School",
    (type == "3rat" & variable == "s2t") ~ "Student/Teacher",
    (type == "4elas" & variable == "s2s") ~ "$\\Delta$\\%Student/$\\Delta$\\%School",
    (type == "4elas" & variable == "s2t") ~ "$\\Delta$\\%Student/$\\Delta$\\%Teacher"
  )) %>%
  unite(row_name, type_lab:variable_lab, sep = " ")
# print
print(df_typevar_counts, n = 100)
```


### Generate table 

Now we generate the table. 

```{r}
ar_st_kableformat <- c("latex", "html")
for (st_kableformat in ar_st_kableformat) {
  # j_China, j_Japan, j_Korea, j_Taiwan,
  # j_Austria, j_Germany, j_France, j_Netherlands, j_Switzerland
  # Column names
  ar_st_colnames <- names(df_korea_wide)
  ar_st_colnames_js <- ar_st_colnames[grepl("j_", ar_st_colnames)]
  ar_st_clean <- stringr::str_replace(ar_st_colnames_js, "j_[[:alnum:]]+-", "")
  ar_st_clean <- stringr::str_replace(ar_st_clean, "nam", "-nam")
  ar_st_clean <- stringr::str_replace(ar_st_clean, "buk", "-buk")
  ar_st_clean <- stringr::str_replace(ar_st_clean, "won", "-won")
  ar_st_clean <- stringr::str_replace(ar_st_clean, "Non-metro", "All")
  ar_st_clean <- stringr::str_replace(ar_st_clean, "Metro", "All")
  ar_st_col_names <- c(
    "Years",
    ar_st_clean
  )
  # Define column groups, grouping the names above
  # =1/3/2 are number of columns group title covers
  ar_st_col_groups_l2 <- c(
    " " = 1,
    "All" = 1,
    "Capital cities" = 3,
    "Metropolitian cities" = 6,
    "All" = 1,
    "Provinces" = 5,
    "Special provinces" = 3
  )
  ar_st_col_groups_l1 <- c(
    " " = 1,
    "Capital and metropolitan areas" = 10,
    "Non-metropolitan areas" = 9
  )

  # select and sort
  tab3_korea_jnt_kbl <- tab3_korea_jnt %>%
    select(
      -type, -variable, -variable_sort,
      yearset, one_of(ar_st_colnames_js)
    )

  # Second, we construct main table, and add styling.
  bk_korea <- kbl(
    tab3_korea_jnt_kbl,
    format = st_kableformat,
    label = "main:tab:korea:pop:teachers:schools",
    # escape = F,
    linesep = "",
    booktabs = T,
    longtable = T,
    align = "c",
    caption = "Korea: Schools, Teachers, and Students",
    col.names = ar_st_col_names
  ) %>%
    # see https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#Bootstrap_table_classes
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = F, position = "left"
    )

  # Third, we add in column groups.
  bk_korea <- bk_korea %>%
    add_header_above(ar_st_col_groups_l2) %>%
    add_header_above(ar_st_col_groups_l1)

  # Fourth, we add in row groups.
  st_supra_grp_cur <- ""
  it_supra_grp_ctr <- 0
  for (it_group in seq(1, dim(df_typevar_counts)[1])) {
    # supra group variable
    st_supra_grp <- as.character(df_typevar_counts[[it_group, "type_lab_supra"]])
    # Reion full name info
    st_loc <- as.character(df_typevar_counts[[it_group, "row_name"]])

    # groups start and end
    it_group_count_start <- df_typevar_counts[[it_group, "group_count_start"]]
    it_group_count_end <- df_typevar_counts[[it_group, "group_count_end"]]

    if (st_supra_grp != st_supra_grp_cur) {
      it_supra_grp_ctr <- it_supra_grp_ctr + 1
      st_supra_grp_cur <- st_supra_grp
      bl_hline_before <- FALSE
      if (it_supra_grp_ctr >= 2) {
        bl_hline_before <- TRUE
      }
      # Heading group stats type
      st_supra_text <- paste0(st_supra_grp_cur)
      bk_korea <- bk_korea %>%
        pack_rows(
          st_supra_text, it_group_count_start, it_group_count_start,
          latex_gap_space = "0.0em",
          indent = FALSE,
          latex_align = "c",
          hline_after = TRUE,
          hline_before = bl_hline_before
        )
    }
    # Add to table
    bk_korea <- bk_korea %>%
      pack_rows(
        st_loc, it_group_count_start, it_group_count_end,
        latex_gap_space = "0.75em",
        latex_align = "l",
        hline_after = FALSE
      )
  }

  # Fifth, column formatting.
  fl_width_country <- 1.9
  st_width_country <- paste0(fl_width_country, "cm")
  bk_korea <- bk_korea %>%
    column_spec(1, width = st_width_country) %>%
    column_spec(2:dim(tab3_korea_jnt_kbl)[2], width = "0.75cm")

  # Final adjustments
  # Headings on all pages, note use `sub` to replace first midrule
  st_headend <- paste0(
    "\\midrule\\endhead\n",
    "\\addlinespace[0.2em]\\hline\\addlinespace[0.2em]\n",
    "\\multicolumn{", dim(tab3_korea_jnt_kbl)[2], "}{r}{\\emph{Continued on next page}}\\\\\n",
    "\\endfoot\\endlastfoot"
  )
  bk_korea <- sub(bk_korea,
    pattern = "\\midrule", replacement = st_headend,
    fixed = TRUE
  )
  # country-names left-align
  bk_korea <- gsub(bk_korea,
    pattern = paste0("\\centering\\arraybackslash}p{", st_width_country, "}"),
    replacement = paste0("\\raggedright\\arraybackslash}p{", st_width_country, "}"),
    fixed = TRUE
  )
  # midrule replacing hline
  bk_korea <- gsub(bk_korea,
    pattern = "hline",
    replacement = "midrule", fixed = TRUE
  )

  # Sixth, display.
  # pl_bk_asset_count <- bk_asset_count %>% as_image()
  # bk_korea
  # Save tex to file.
  if (st_kableformat == "html") {
    print(dim(bk_korea))
  } else {
    if (bl_tex_save) {
      fileConn <- file(spn_tex_out)
      writeLines(bk_korea, fileConn)
      close(fileConn)
      if (verbose) {
        print(glue::glue("F-945386, S1"))
        print(glue::glue("Latex saved: {spn_tex_out}"))
      }
    }
  }
}
bk_korea
```
