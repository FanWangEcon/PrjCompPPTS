---
title: "Compute Percentage Changes of School Resources and Population"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Compute Percentage Changes of School Resources and Population}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r setup}
library(tibble)
library(dplyr)
library(tidyr)
library(readr)
library(kableExtra)

library(PrjCompPPTS)
```

In this file, we compute percentage changes in school resources and population. We interpolate when there is gaps in the data. 

For all variables, for each country/location, we compute: 

- percentage changes year by year
- percentage changes every 5, 10, 15, and 20 years. 

<!-- TODO: Something is wrong Afgphanistan teachers 1989 -->

## Load and select

```{r}
# A. Load and select ----
ppts_easia_weuro_sel <- ppts_easia_weuro_world %>%
  select(countrycode, area_in_country, year,
         contains("stats"), -stats_enroll_ratio)
```

## Transform data

```{r}
# B. Long to wide ----
ppts_easia_weuro_long <- ppts_easia_weuro_sel %>%
  pivot_longer(cols = starts_with('stats'),
               names_to = c('variable'),
               names_pattern = paste0("stats_(.*)"),
               values_to = "value")
str(ppts_easia_weuro_long)
# View(ppts_easia_weuro_long)


# C sort and group ----
ppts_easia_weuro_long <- ppts_easia_weuro_long %>%
  arrange(countrycode, area_in_country, variable, year) %>%
  group_by(countrycode, area_in_country, variable)
print(ppts_easia_weuro_long[1:50,])
```

## Compute annual percentage changes

### Raw percentage changes

```{r}
# D. Annual percentage changes ----
# Compute these
# - annual: for all possible consecutive years
# - annual_interp1: annual based on consecutive year if possible, 
# when that is not possible, find closest years of available data, 
# and derive annual (considering compounding) growth rates

# D.1 annual
ppts_easia_weuro_long <- ppts_easia_weuro_long %>%
  mutate(pchg_yr1 = (value - lag(value)) / lag(value))
print(ppts_easia_weuro_long[1:50,])
```

### Interpolating 

```{r}
# D.2 annual_interp1
# D.2.1 compute linearly interpolated annual change
# create new sorting var, to take difference across years even if not
# consecutive
ppts_easia_weuro_interp1 <- ppts_easia_weuro_long %>%
  drop_na(value) %>%
  # New sorting variable, +1 regardless of year gap
  mutate(year_with_gap_ctr = row_number()) %>%
  arrange(countrycode, area_in_country, variable, year_with_gap_ctr) %>%
  group_by(countrycode, area_in_country, variable) %>%
  # compute percentage change over span and years gap over span
  mutate(pchg_span_interp1 = (value - lag(value)) / lag(value),
         span_yr = (year - lag(year))) %>%
  # linear-interpolated annualized (with compounding) percentage change
  mutate(pchg_yr1_interp1 = abs(1 + pchg_span_interp1) ^ (1 / span_yr) - 1) %>%
  select(countrycode, area_in_country,
         year, variable, span_yr, pchg_yr1_interp1)

# D.2.2 expand to all interpolating years
# the pchg_yr1_interp1 variable is only shown at start year, 
# due to drop_na(value) earlier
# need to expand to all years
ppts_easia_weuro_interp1 <- ppts_easia_weuro_interp1 %>%
  ungroup() %>% mutate(span_yr_dup = span_yr) %>%
  drop_na(span_yr) %>%
  tidyr::uncount(span_yr) %>%
  group_by(countrycode, area_in_country, variable, year) %>%
  mutate(year_adj = row_number() + year - span_yr_dup) %>%
  ungroup() %>%
  select(countrycode, area_in_country,
         year_adj, variable, pchg_yr1_interp1) %>%
  rename(year = year_adj)
str(ppts_easia_weuro_interp1)
print(ppts_easia_weuro_interp1[1:50,])
```

### Merge raw and interpolated results together

```{r}
# D.3 merge together
ppts_easia_weuro_long <- ppts_easia_weuro_long %>%
  left_join(ppts_easia_weuro_interp1,
            by = (c('countrycode' = 'countrycode',
                    'area_in_country' = 'area_in_country',
                    'year' = 'year',
                    'variable' = 'variable')))

str(ppts_easia_weuro_long)
print(ppts_easia_weuro_long[1:50,])
```

## Generate percentage changes every 5, 10, 15, 20 years 

We now consider several different cuts, over the end-points of which we compute percentage changes. 

```{r}
# Every five years from 1940 until 2020
ar_it_cuts_1940t2020_i05 <- seq(1940, 2020, length.out = 17)
st_cuts_1940t2020_i05 <- "1940t2020i05"
# Every ten years from 1940 until 2020
ar_it_cuts_1940t2020_i10 <- seq(1940, 2020, length.out = 9)
st_cuts_1940t2020_i10 <- "1940t2020i10"
# Every 15 years from 1940 until 2020
ar_it_cuts_1940t2020_i15 <- seq(1945, 2020, length.out = 6)
st_cuts_1940t2020_i15 <- "1940t2020i15"
# Every 20 years from 1940 until 2020
ar_it_cuts_1940t2020_i20 <- seq(1940, 2020, length.out = 5)
st_cuts_1940t2020_i20 <- "1940t2020i20"
```

We put the cuts and the associated string names into two lists. 

```{r}
# List of cuts
ls_ar_it_cuts <- list(
  ar_it_cuts_1940t2020_i05,
  ar_it_cuts_1940t2020_i10,
  ar_it_cuts_1940t2020_i15,
  ar_it_cuts_1940t2020_i20
)
# Add names
names(ls_ar_it_cuts) <- c(
  st_cuts_1940t2020_i05,
  st_cuts_1940t2020_i10,
  st_cuts_1940t2020_i15,
  st_cuts_1940t2020_i20
)
# Display
for (st_cuts_name in names(ls_ar_it_cuts)) {
  print(glue::glue(
    "cutTypeName={st_cuts_name}:\n",
    "bins={ls_ar_it_cuts[st_cuts_name]}"))
}
```

Generate percentage changes across start end end points of each bin, for bins of varying length. 

```{r}
# E. Generate cuts -----
it_avg_type <- 1
it_cut_type <- 1
for (it_avg_type in c(1, 2)) {
  
  if (it_avg_type == 1) {
    svr_chg_var <- "pchg_yr1"
    # common var across all spans
    svr_chg_var_new <- "pchg"
  } else if (it_avg_type == 2) {
    svr_chg_var <- "pchg_yr1_interp1"
    # common var across all spans
    svr_chg_var_new <- "pchg_interp1"
  }
  
  # Add to stack the annual results
  ppts_easia_weuro_pchg <- ppts_easia_weuro_long %>%
    select(countrycode, area_in_country,
           variable, year, one_of(svr_chg_var), value) %>%
    drop_na(one_of(svr_chg_var)) %>%
    rename(!!sym(svr_chg_var_new) := !!sym(svr_chg_var),
           year_bins = year) %>%
    mutate(year_bins = as.factor(year_bins)) %>%
    mutate(year_bins_type = "i01_annual") %>%
    ungroup()
  
  # Loop over cut types    
  for (st_cuts_name in names(ls_ar_it_cuts)) {
    print(glue::glue(
      "cutTypeName={st_cuts_name}:\n",
      "bins={ls_ar_it_cuts[st_cuts_name]}"))
    
    # temp dataframe
    ppts_easia_weuro_long_cut <- ppts_easia_weuro_long %>%
      select(countrycode, area_in_country,
             variable, year,
             one_of(svr_chg_var), value) %>%
      drop_na(one_of(svr_chg_var))
    
    # E.1 Cut types
    ar_it_cuts <- ls_ar_it_cuts[[st_cuts_name]]
    it_gap <- ar_it_cuts[2] - ar_it_cuts[1]
    ar_it_end_seg <- ar_it_cuts[2:length(ar_it_cuts)]
    ar_it_start_seg <- ar_it_end_seg - it_gap + 1
    ar_st_lab <- paste0(ar_it_start_seg, "-", ar_it_end_seg)
    
    # E.2 Generate new year groupings, consider only full-segments
    # consider only sub-segments with observations in all years
    ppts_easia_weuro_long_cut <- ppts_easia_weuro_long_cut %>%
      mutate(year_bins = cut(year,
                             breaks = ar_it_cuts,
                             labels = ar_st_lab,
                             right = TRUE)) %>%
      group_by(countrycode, area_in_country,
               variable, year_bins) %>%
      mutate(val_n_in_bin = n()) %>%
      # if gap is 5 years, all 5 years has annual chagne
      filter(val_n_in_bin == it_gap)
    
    # E.3 cumulative product
    ppts_easia_weuro_long_cut <- ppts_easia_weuro_long_cut %>%
      group_by(countrycode, area_in_country,
               variable, year_bins) %>%
      mutate(!!sym(svr_chg_var_new) :=
               cumprod(1 + !!sym(svr_chg_var)) - 1)
    # View(ppts_easia_weuro_long_cut)
    
    # E.4, slices last row
    ppts_easia_weuro_long_cut <- ppts_easia_weuro_long_cut %>%
      slice(n()) %>%
      select(countrycode, area_in_country,
             variable, year_bins, one_of(svr_chg_var_new), value) %>%
      ungroup() %>%
      mutate(year_bins_type = st_cuts_name)
    
    # E.5 Stack
    ppts_easia_weuro_pchg <- bind_rows(
      ppts_easia_weuro_pchg, ppts_easia_weuro_long_cut)
  }
  
  # export
  if (it_avg_type == 1) {
    ppts_easia_weuro_pchg_raw <- ppts_easia_weuro_pchg
  } else if (it_avg_type == 2) {
    ppts_easia_weuro_pchg_interp1 <- ppts_easia_weuro_pchg %>%
      rename(value_interp1 = value)
  }
}
print(ppts_easia_weuro_pchg_interp1[1:50,])
```

### Merge raw and interpolated results together, again 

After generating percentage changes over different spans, merge again. 

```{r}
# D.3 merge together
# full_join same as left_join, 
ppts_easia_weuro_world_pchg <- ppts_easia_weuro_pchg_interp1 %>%
  full_join(ppts_easia_weuro_pchg_raw,
            by = (c('countrycode' = 'countrycode',
                    'area_in_country' = 'area_in_country',
                    'variable' = 'variable', 
                    'year_bins_type' = 'year_bins_type',
                    'year_bins' = 'year_bins'
            ))) %>% 
  mutate(variable = as.factor(variable), 
         year_bins_type = as.factor(year_bins_type)) %>%
  select(countrycode, area_in_country, 
         variable, 
         year_bins_type, year_bins, 
         pchg, pchg_interp1, 
         value, value_interp1)

str(ppts_easia_weuro_world_pchg)
print(ppts_easia_weuro_world_pchg[1:50,])
```


## Store to file 

We save both the raw file without interpolation and the file with gaps filled in by interpolation.

```{R}
# Write to CSV and write to rda
write_csv(ppts_easia_weuro_world_pchg, "../data/ppts_easia_weuro_world_pchg.csv")
usethis::use_data(ppts_easia_weuro_world_pchg, overwrite = TRUE)
```
