---
title: "Table: Global students and teachers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Table: Global students and teachers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tibble)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(kableExtra)

library(PrjCompPPTS)
# If resave outputs to data, only do this during development
verbose <- TRUE
bl_tex_save <- FALSE
spt_path_res <- file.path("..", "res-tab", fsep = .Platform$file.sep)
spn_tex_out <- file.path(spt_path_res, "tab_global_students_teachers.tex", fsep = .Platform$file.sep)
```

[Implement PrjCompPPTS-2](https://github.com/FanWangEcon/PrjCompPPTS/issues/2), Summ: Global teachers and students.

We generate a table with these possible variables:

- Unit of observation: country at selected years
- var country
- var (3) children to teacher ratio in 1960, 1980, 2000, 2020
- var (1) global ranking in 2020
- var (1) percentage change in teachers 1980 to 2020
- var (1) teacher-students elasticity
- var (1) percentage change in teachers 2000 to 2020
- var (1) teacher-students elasticity

## Generate input file

### Load prepped all location level files

Load file with interpolated data.

```{r}
# Locaiton codes
ppts_code_wrk <- ppts_country_code
# We load in the global students data.
df_ppts <- ppts_easia_weuro_world_pchg
```

### Run PrjCompPPTS functions

Run functions to generate FLR, FPC, and FEL files. Run FLR. 

```{r}
# Generate PLR
df_flr <- PrjCompPPTS::ff_ppts_lrce_flr(
  df_ppts,
  st_year_bins_type = "1940t2020i01",
  ar_it_years = c(1960, 1980, 1990, 2000, 2010, 2020),
  verbose = TRUE
)
```

Run FPC.

```{r}
# Generate FPC
df_fpc <- PrjCompPPTS::ff_ppts_lrce_fpc(
  df_flr,
  ar_it_years_chg = c(1960, 1980, 2000, 2020),
  ls_chg_years = list(
    "chg_80v60" = c(1960, 1980),
    "chg_00v80" = c(1980, 2000),
    "chg_20v00" = c(2000, 2020),
    "chg_20v80" = c(1980, 2020)
  ), verbose = TRUE
)
```

Run FEL. 

```{r}
# Generate FEL
df_fel <- PrjCompPPTS::ff_ppts_lrce_fel(
  df_fpc,
  verbose = TRUE
)
```

### Merge FPC and FEL, country and region

Now we combine the level and change information from FPC with the elasticity results from FEL.

We have the LRCE file, level, ratio, change, and elasticity.

```{r}
df_lrce <- df_fpc %>% left_join(
  df_fel %>% mutate(vartype = "rat"),
  by = (c(
    "location_code" = "location_code",
    "location_level" = "location_level",
    "variable" = "variable",
    "vartype" = "vartype"
  ))
)
print(glue::glue("dim df_lrce: {dim(df_lrce)}"))
```

Finally, merge in country key info to FPC, country-level information.

```{r}
df_lrce_country <- df_lrce %>%
  filter(location_level != "multicountry") %>%
  left_join(
    ppts_code_wrk %>%
      select(
        location_name, location_code,
        location_region_group, location_region_group_code
      ),
    by = c("location_code" = "location_code")
  ) %>%
  # mutate(location_name_full = paste0(location_name, " (", location_code, ")")) %>%
  mutate(location_name_full = paste0(location_name)) %>%
  select(-location_name) %>%
  select(location_name_full, location_region_group, everything()) %>%
  arrange(location_region_group_code, location_name_full)
```

FPC regional information, same variables.

```{r}
ar_st_wb7 <- c("SSF", "MEA", "LCN", "NAC", "SAS", "ECS", "EAS")
df_lrce_region <- df_lrce %>%
  filter(location_level == "multicountry") %>%
  filter(location_code %in% ar_st_wb7) %>%
  left_join(
    ppts_code_wrk %>%
      select(
        location_name, location_code, location_code_adj,
        location_region_group, location_region_group_code
      ),
    by = c("location_code" = "location_code")
  ) %>%
  select(-location_code) %>%
  rename(location_code = location_code_adj) %>%
  # mutate(location_name_full = paste0(location_name, " (", location_code, ")")) %>%
  mutate(location_name_full = paste0(location_name)) %>%
  select(-location_name) %>%
  select(location_name_full, location_region_group, everything()) %>%
  mutate(
    location_region_group_code = "0WORLD",
    location_region_group = "Global regions"
  ) %>%
  arrange(location_region_group_code, location_code)
```

Combine region and country.

```{r}
df_lrce_region_country <- bind_rows(
  df_lrce_region,
  df_lrce_country %>% filter(location_level == "country"),
)
```

## Table students and teachers

Now we develop the table for students to teacher ratio.

### Prep table inputs

Select and prep Table 2. Combine national and regional data together.

First, select ratio and elasticity.

```{r}
# Select s2t ratio levels and elasticity
tab2_s2t_rat_elas <- df_lrce_region_country %>%
  filter(
    vartype == "rat",
    variable == "s2t"
  ) %>%
  select(
    -vartype, -variable, -location_level, -location_code,
    -year1960, -contains("chg"), -elas_80v60
  ) %>%
  rename_at(vars(matches("elas_|year")), ~ paste0(., "_s2t"))
print(glue::glue("dim tab2_s2t_rat_elas: {dim(tab2_s2t_rat_elas)}"))
```

Second, ranks.

```{r}
# Select s2t ratio levels and elasticity
tab2_s2t_rat_rank <- df_lrce_region_country %>%
  filter(
    vartype == "rank",
    variable == "s2t"
  ) %>%
  select(
    -vartype, -variable, -location_level, -location_code,
    -year1960, -contains("chg"), -contains("elas"),
  ) %>%
  rename_at(vars(matches("year")), ~ paste0(., "_s2t_rank"))
print(glue::glue("dim tab2_s2t_rat_rank: {dim(tab2_s2t_rat_rank)}"))
```

Second, select percentage changes.

```{r}
# Select percentage changes in youth
tab2_youthstudentteacher_lvl <- df_lrce_region_country %>%
  filter(
    vartype == "lvl",
    variable %in% c("youthpop", "student", "teacher")
  ) %>%
  select(
    -vartype, -location_level, -location_code,
    -year1960,
    -contains("year"), -contains("elas_"), -chg_80v60
  ) %>%
  pivot_wider(
    id_cols = c(
      "location_name_full",
      "location_region_group",
      "location_region_group_code"
    ),
    names_from = variable,
    names_prefix = "",
    names_sep = "_",
    values_from = c(contains("chg_"))
  )
print(glue::glue("dim tab2_youthstudentteacher_lvl: {dim(tab2_youthstudentteacher_lvl)}"))
```

Third, combine information together

```{r}
tab_2_global_pop_teacher <- tab2_youthstudentteacher_lvl %>%
  left_join(
    tab2_s2t_rat_elas,
    by = c(
      "location_name_full" = "location_name_full",
      "location_region_group" = "location_region_group",
      "location_region_group_code" = "location_region_group_code"
    )
  ) %>%
  left_join(
    tab2_s2t_rat_rank,
    by = c(
      "location_name_full" = "location_name_full",
      "location_region_group" = "location_region_group",
      "location_region_group_code" = "location_region_group_code"
    )
  )
```

Fourth, select a subset of variables for visualizations. Include the following:

- var country
- var (3) children to teacher ratio in 1980, 2000, 2020
- var (1) global ranking in 2020
- var (1) percentage change in student 1980 to 2020
- var (1) percentage change in teachers 1980 to 2020
- var (1) teacher-students elasticity

```{r}
# Select data
tab_2_global_student_teacher_v1 <- tab_2_global_pop_teacher %>%
  select(
    contains("location"),
    year1980_s2t, year2000_s2t, year2020_s2t,
    chg_20v00_student, chg_20v00_teacher, elas_20v00_s2t,
    chg_20v80_student, chg_20v80_teacher, elas_20v80_s2t
  )
# drop no data rows
tab_2_global_student_teacher_v1 <- tab_2_global_student_teacher_v1 %>%
  mutate(
    avg_stats = base::rowMeans(
      dplyr::pick(matches("year|chg|elas")),
      na.rm = TRUE
    )
  ) %>%
  drop_na(avg_stats) %>%
  select(-avg_stats)
```

Fourth, count variables in regional groups.

```{r}
df_region_counts <- tab_2_global_student_teacher_v1 %>%
  group_by(
    location_region_group_code, location_region_group
  ) %>%
  summarize(region_count = n()) %>%
  ungroup() %>%
  mutate(region_count_start = cumsum(region_count) - region_count + 1) %>%
  mutate(region_count_end = cumsum(region_count)) %>%
  select(region_count_start, region_count_end, everything())
```

Third, format variables and replace NAs.

```{r}
# Format variables
tab_2_global_student_teacher_v1 <- tab_2_global_student_teacher_v1 %>%
  select(-location_region_group, -location_region_group_code) %>%
  mutate_at(
    vars(contains("year")),
    list(~ paste0(
      format(round(., 0), nsmall = 0, big.mark = ",")
    ))
  ) %>%
  mutate_at(
    vars(contains("elas")),
    list(~ paste0(
      format(round(., 2), nsmall = 0, big.mark = ",")
    ))
  ) %>%
  mutate_at(
    vars(contains("chg")),
    list(~ paste0(
      format(round(., 2) * 100,
        nsmall = 0,
        big.mark = ","
      ),
      "%"
    ))
  )
# Replace NAs
tab_2_global_student_teacher_v1 <- tab_2_global_student_teacher_v1 %>%
  mutate_at(vars(starts_with("chg")), ~ str_replace(., "NA%", "")) %>%
  mutate_at(vars(starts_with("year")), ~ str_replace(., "NA", "")) %>%
  mutate_at(vars(starts_with("elas")), ~ str_replace(., "NA", ""))
```

### Generate table

Now we generate the table.

```{r}
ar_st_kableformat <- c("latex", "html")
for (st_kableformat in ar_st_kableformat) {
  # Column names
  ar_st_col_names <- c(
    "Country by region",
    "1980",
    "2000",
    "2020",
    "Students",
    "Teachers",
    "$\\Delta$\\%T/$\\Delta$\\%Y",
    "Students",
    "Teachers",
    "$\\Delta$\\%T/$\\Delta$\\%Y"
  )
  # Define column groups, grouping the names above
  # =1/3/2 are number of columns group title covers
  ar_st_col_groups_l1 <- c(
    " " = 1,
    "Ratios" = 3,
    # "Rank" = 1,
    "\\% change" = 2,
    "Elasticity" = 1,
    "\\% change" = 2,
    "Elasticity" = 1
  )
  ar_st_col_groups_l2 <- c(
    " " = 1,
    "Student to teacher" = 3,
    "2000 to 2020" = 3,
    "1980 to 2020" = 3
  )

  # Second, we construct main table, and add styling.
  bk_student_teacher_rela <- kbl(
    tab_2_global_student_teacher_v1 %>%
      select(
        location_name_full,
        year1980_s2t, year2000_s2t, year2020_s2t,
        chg_20v00_student, chg_20v00_teacher, elas_20v00_s2t,
        chg_20v80_student, chg_20v80_teacher, elas_20v80_s2t
      ),
    format = st_kableformat,
    label = "main:tab:global:students:teachers",
    # escape = F,
    linesep = "",
    booktabs = T,
    longtable = T,
    align = "c",
    caption = "Global changes in primary students and teachers",
    col.names = ar_st_col_names
  ) %>%
    # see https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html#Bootstrap_table_classes
    kable_styling(
      bootstrap_options = c("striped", "hover", "condensed", "responsive"),
      full_width = F, position = "left"
    )

  # Third, we add in column groups.
  bk_student_teacher_rela <- bk_student_teacher_rela %>%
    add_header_above(ar_st_col_groups_l1) %>%
    add_header_above(ar_st_col_groups_l2)

  # Fourth, we add in row groups.
  for (it_region in seq(1, dim(df_region_counts)[1])) {
    # Reion full name info
    st_loc <- as.character(df_region_counts[[it_region, "location_region_group"]])

    # Regions start and end
    it_region_count_start <- df_region_counts[[it_region, "region_count_start"]]
    it_region_count_end <- df_region_counts[[it_region, "region_count_end"]]

    # Add to table
    bk_student_teacher_rela <- bk_student_teacher_rela %>%
      pack_rows(
        st_loc, it_region_count_start, it_region_count_end,
        latex_gap_space = "1em",
        latex_align = "c",
        hline_after = TRUE
      )
  }

  # Fifth, column formatting.
  fl_width_country <- 3.4
  st_width_country <- paste0(fl_width_country, "cm")
  bk_student_teacher_rela <- bk_student_teacher_rela %>%
    column_spec(1, width = st_width_country) %>%
    column_spec(2:10, width = "0.9cm")

  # Final adjustments
  # Headings on all pages, note use `sub` to replace first midrule
  st_headend <- paste0(
    "\\midrule\\endhead\n",
    "\\addlinespace[0.2em]\\hline\\addlinespace[0.2em]\n",
    "\\multicolumn{10}{r}{\\emph{Continued on next page}}\\\\\n",
    "\\endfoot\\endlastfoot"
  )
  bk_student_teacher_rela <- sub(bk_student_teacher_rela,
    pattern = "\\midrule", replacement = st_headend,
    fixed = TRUE
  )
  # country-names left-align
  bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
    pattern = paste0("\\centering\\arraybackslash}p{", st_width_country, "}"),
    replacement = paste0("\\raggedright\\arraybackslash}p{", st_width_country, "}"),
    fixed = TRUE
  )
  # midrule replacing hline
  bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
    pattern = "hline",
    replacement = "midrule", fixed = TRUE
  )
  # Backslash replace
  bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
    pattern = "\\textbackslash{}Delta", replacement = "\\Delta", fixed = TRUE
  )
  bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
    pattern = "\\textbackslash{}", replacement = "", fixed = TRUE
  )
  bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
    pattern = "\\$", replacement = "$", fixed = TRUE
  )
  # bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
  #   pattern = "\\%Y",  replacement = "%Y", fixed = TRUE
  # )
  # bk_student_teacher_rela <- gsub(bk_student_teacher_rela,
  #   pattern = "\\% change",  replacement = "% change", fixed = TRUE
  # )

  # Sixth, display.
  # pl_bk_asset_count <- bk_asset_count %>% as_image()
  if (st_kableformat == "html") {
    print(dim(bk_student_teacher_rela))
  } else {
    if (bl_tex_save) {
      fileConn <- file(spn_tex_out)
      writeLines(bk_student_teacher_rela, fileConn)
      close(fileConn)
      if (verbose) {
        print(glue::glue("Latex saved: {spn_tex_out}"))
      }
    }
  }
}
bk_student_teacher_rela
```
