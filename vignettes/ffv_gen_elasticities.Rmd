---
title: "Compute Elasticities of School Resources to Changes in Populations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Compute Elasticities of School Resources to Changes in Populations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(tibble)
library(dplyr)
library(tidyr)
library(stringr)
library(readr)
library(kableExtra)

library(PrjCompPPTS)
# If resave outputs to data, only do this during development
bl_resave_to_data <- FALSE
```

In this file, we compute all potential elasticities of school resource changes 
given changes in school age populations. 

Elasticity of schools with respect to (school-age) population is the percentage change 
in the number of schools divided by percentage change in the school-age population.

Elasticity of teachers with respect to (school-age) population is the percentage change
in the number of teachers divided by percentage change in the school-age population.

## Load data inputs and review

We load in the global population data. 

```{r}
# File use
bl_interp <- FALSE
ppts_wrk <- ppts_easia_weuro_world_pchg %>% 
  filter(!str_detect(year_bins_type, "1940t2020i01"))

str(ppts_wrk)
```

We review all unique values in variables. We get all unique "variable" values, drop enroll_ratio

```{r}
ar_st_vars <- unique(
    ppts_wrk %>%
    pull(variable))
print(ar_st_vars)
```

## Numerator and denominator percentage changes and Elasticity

We generate separate columns for each of the "variables", containing the percentage change value for each variable. These columns will be numerators, and the original column will be the denominator. 

Then, we reshape the file just created, so that all "numerators" will be in the same column. 

We compute elasticities after 

```{r}
it_avg_type <- 1
for (it_avg_type in c(1, 2)) {
  
  if (it_avg_type == 1) {
    svr_var_val_exclude <- c("value_interp1", "pchg_interp1")
    svr_var_val <- "value"
    svr_chg_var <- "pchg"
    svr_chg_var_num <- "pchg_numerator"
    svr_elas_var <- "elasticity"
  } else if (it_avg_type == 2) {
    svr_var_val_exclude <- c("value", "pchg")
    svr_var_val <- "value_interp1"
    svr_chg_var <- "pchg_interp1"
    svr_chg_var_num <- "pchg_interp1_numerator"
    svr_elas_var <- "elasticity_interp1"
  }  
 
  ppts_wrk_jnt <- ppts_wrk %>% 
    select(-one_of(svr_var_val_exclude))
  ar_st_cur_col_var <- ar_st_vars
  for (st_cur_col_var in ar_st_cur_col_var) {
  #   st_cur_col_var <- "school"
    st_new_col_var <- paste0("pchgnum_", st_cur_col_var)
    # 20. Generate "variable"-specific dataframes
    ppts_one_var <- ppts_wrk %>%
      select(-one_of(svr_var_val_exclude)) %>%
      filter(variable == st_cur_col_var) %>%
      select(-!!sym(svr_var_val), - variable) %>%
      rename(!!sym(st_new_col_var) := !!sym(svr_chg_var))

    # 30. Merge "variable"-specific dataframe to main
    ppts_wrk_jnt <- ppts_wrk_jnt %>%
      left_join(ppts_one_var,
          by = (c(
              "location_code" = "location_code",
              "location_level" = "location_level",
              "year_bins_type" = "year_bins_type",
              "year_bins" = "year_bins"
          )))
  }

  # Show variable names
  print(colnames(ppts_wrk_jnt))
  print(dim(ppts_wrk_jnt))

  # 60. Reshape from wide to long, rename variable numerator, variable denominator
  ppts_wrk_jnt_long <- ppts_wrk_jnt %>% 
    pivot_longer(cols = starts_with('pchgnum'),
                names_to = c('variable_numerator'),
                names_pattern = paste0("pchgnum_(.*)"),
                values_to = svr_chg_var_num)

  # 70. Compute elasticity
  # Now, we simply divide the numerator from the variable "pchg_yrspan_interp1_numerator" by the values in "pchg_yrspan_interp1", which is the denominator. 
  # Compute elasticities
  ppts_wrk_jnt_long <- ppts_wrk_jnt_long %>%
    mutate(!!sym(svr_elas_var) :=   
      !!sym(svr_chg_var_num)/!!sym(svr_chg_var))
  # Keep the elasticity column 
  # ppts_wrk_jnt_long <- ppts_wrk_jnt_long %>% 
  #   select(-contains("value"))

  # 61. save files 
  if (it_avg_type == 1) {
    ppts_wrk_jnt_long_val <- ppts_wrk_jnt_long
  } else if (it_avg_type == 2) {
    ppts_wrk_jnt_long_interp1 <- ppts_wrk_jnt_long
  }  
}

# Display
# print(ppts_wrk_jnt_long[1:50,])
kable(ppts_wrk_jnt_long_interp1 %>% select(-location_level) %>%
        filter(location_code == 'AFG' & 
          variable == 'student' & 
          variable_numerator == 'youthpop'))
```

## Examine elasticities 

We now review the computed elasticity results to make sure things appear as expected. 

## Save elasticity file 

```{r}
# Review file variable names
print(colnames(ppts_wrk_jnt_long))
print(str(ppts_wrk_jnt_long))
# Save file
if (bl_resave_to_data) {
  ppts_easia_weuro_world_elas_interp1 <- ppts_wrk_jnt_long_interp1
  write_csv(ppts_easia_weuro_world_elas_interp1, "../data/ppts_easia_weuro_world_elas_interp1.csv")
  usethis::use_data(ppts_easia_weuro_world_elas_interp1, overwrite = TRUE)
  
  ppts_easia_weuro_world_elas_raw <- ppts_wrk_jnt_long_val
  write_csv(ppts_easia_weuro_world_elas_raw, "../data/ppts_easia_weuro_world_elas_raw.csv")
  usethis::use_data(ppts_easia_weuro_world_elas_raw, overwrite = TRUE)
}
```
